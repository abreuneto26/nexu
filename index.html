<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NexusMed AI - Prontuário Inteligente</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #a78bfa; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #4c1d95; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #5b21b6; }
    
    /* Glass Effects */
    .glass-dark {
      background: rgba(20, 10, 30, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(139, 92, 246, 0.15);
    }
    .glass-light {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(221, 214, 254, 0.8);
      box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.05);
    }

    /* Print Styles */
    @media print {
      body { background: white; color: black; }
      .no-print { display: none !important; }
      .print-full { width: 100% !important; height: 100% !important; position: absolute; top: 0; left: 0; margin: 0; }
    }
  </style>
</head>
<body class="h-screen overflow-hidden selection:bg-violet-500 selection:text-white bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;
    const { createRoot } = ReactDOM;
    
    // Lucide Icons Destructuring
    const { 
      Stethoscope, FileText, Pill, Users, BrainCircuit, Mic, Upload, Camera, Calculator, 
      Wand2, Network, Save, Trash2, Check, X, Search, Plus, Printer, ChevronDown, 
      ChevronRight, Menu, FileOutput, Sun, Moon, ArrowLeft, Play, Activity, Syringe, 
      Heart, Baby, Siren, FileBadge, Bone, Brain, Eye, ScanFace, Droplet, Microscope, 
      Zap, BookOpen, Sparkles, AlertTriangle, Split, ShieldAlert, TestTube2, Settings, 
      Palette, Thermometer, Scissors, Dna, Calendar, Image: ImageIcon, Library, GraduationCap, 
      MessageCircle, LogOut, Layout, TableProperties, UploadCloud, FilePlus, Edit3, AlignLeft, Key 
    } = lucide.icons;

    // --- GEMINI REST API WRAPPER ---
    class GoogleGenAI {
      constructor({ apiKey }) {
        this.apiKey = apiKey;
        this.baseUrl = "https://generativelanguage.googleapis.com/v1beta/models";
      }

      get models() {
        return {
          generateContent: async ({ model, contents, config }) => {
            const url = `${this.baseUrl}/${model}:generateContent?key=${this.apiKey}`;
            
            const body = {
              contents: Array.isArray(contents) ? contents : (contents.parts ? [contents] : [{ parts: [{ text: contents }] }]),
              generationConfig: config ? {
                responseMimeType: config.responseMimeType,
                responseSchema: config.responseSchema,
                temperature: config.temperature,
                topK: config.topK,
                topP: config.topP,
              } : undefined
            };

            const response = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });

            if (!response.ok) {
              const err = await response.json();
              throw new Error(err.error?.message || 'Erro na API Gemini');
            }

            const data = await response.json();
            
            return {
              text: data.candidates?.[0]?.content?.parts?.map(p => p.text).join('') || '',
              candidates: data.candidates
            };
          }
        };
      }
    }

    // --- DATABASES ---
    const MEDICATIONS_DB = [
      { name: "Dipirona 500mg", type: "Analgesico", posology: "1 comprimido VO a cada 6h SN." },
      { name: "Dipirona 1g", type: "Analgesico", posology: "1 comprimido VO a cada 6h SN." },
      { name: "Paracetamol 500mg", type: "Analgesico", posology: "1 comprimido VO a cada 6h SN." },
      { name: "Paracetamol 750mg", type: "Analgesico", posology: "1 comprimido VO a cada 6h SN." },
      { name: "Ibuprofeno 400mg", type: "AINE", posology: "1 comprimido VO a cada 8h após refeições." },
      { name: "Ibuprofeno 600mg", type: "AINE", posology: "1 comprimido VO a cada 8h após refeições." },
      { name: "Cetoprofeno 100mg", type: "AINE", posology: "1 comprimido VO a cada 12h." },
      { name: "Nimesulida 100mg", type: "AINE", posology: "1 comprimido VO a cada 12h por 3-5 dias." },
      { name: "Amoxicilina 500mg", type: "Antibiotico", posology: "1 cápsula VO de 8/8h por 7 dias." },
      { name: "Amoxicilina + Clavulanato 875/125mg", type: "Antibiotico", posology: "1 comprimido VO de 12/12h por 7-10 dias." },
      { name: "Azitromicina 500mg", type: "Antibiotico", posology: "1 comprimido VO por dia por 3-5 dias." },
      { name: "Ciprofloxacino 500mg", type: "Antibiotico", posology: "1 comprimido VO de 12/12h por 7-10 dias." },
      { name: "Cefalexina 500mg", type: "Antibiotico", posology: "1 cápsula VO de 6/6h por 7 dias." },
      { name: "Losartana 50mg", type: "Anti-hipertensivo", posology: "1 comprimido VO 12/12h." },
      { name: "Enalapril 10mg", type: "Anti-hipertensivo", posology: "1 comprimido VO 12/12h." },
      { name: "Anlodipino 5mg", type: "Anti-hipertensivo", posology: "1 comprimido VO 1x ao dia." },
      { name: "Hidroclorotiazida 25mg", type: "Diurético", posology: "1 comprimido VO pela manhã." },
      { name: "Simvastatina 20mg", type: "Lipidimico", posology: "1 comprimido VO a noite." },
      { name: "Omeprazol 20mg", type: "IBP", posology: "1 cápsula VO em jejum." },
      { name: "Metformina 500mg", type: "Hipoglicemiante", posology: "1 comprimido VO após almoço e jantar." },
      { name: "Clonazepam 0.25mg (Sublingual)", type: "Benzodiazepínico", posology: "1 comprimido SL SN crise ansiedade." },
      { name: "Sertralina 50mg", type: "Antidepressivo", posology: "1 comprimido pela manhã." },
      { name: "Loratadina 10mg", type: "Antialérgico", posology: "1 comprimido 1x ao dia." },
      { name: "Prednisolona 20mg", type: "Corticosteróide", posology: "1 comprimido pela manhã por 5 dias." }
    ];

    const EXAMS_DB = [
      { name: "Hemograma Completo" }, { name: "Plaquetas" }, { name: "Glicemia de Jejum" }, 
      { name: "Hemoglobina Glicada" }, { name: "Colesterol Total e Frações" }, { name: "Triglicerídeos" },
      { name: "Ureia" }, { name: "Creatinina" }, { name: "TGO (AST)" }, { name: "TGP (ALT)" }, 
      { name: "Gama GT" }, { name: "TSH" }, { name: "T4 Livre" }, { name: "EAS (Urina Tipo 1)" },
      { name: "Urocultura" }, { name: "Beta HCG" }, { name: "Raio-X de Tórax" }, { name: "ECG" },
      { name: "USG Abdome Total" }
    ];

    const TOOLS_DB = {
      "IA Estratégica": [
        { name: "Segunda Opinião", desc: "Avalia criticamente a coleta do SOAP e sugere prioridades." },
        { name: "Diagnóstico Diferencial", desc: "Gera lista de hipóteses ordenadas por probabilidade." },
        { name: "Detector de Red Flags", desc: "Escaneia o caso em busca de sinais de alarme." },
        { name: "Interpretar Labs", desc: "Análise profunda de distúrbios e exames." },
        { name: "Análise Interação Medicamentosa", desc: "Verifica interações graves entre drogas." }
      ],
      "Cardiologia": [
        { name: "Escore HEART", desc: "Risco para dor torácica na emergência." },
        { name: "Calculadora CHA2DS2-VASc", desc: "Risco de AVC em FA." },
        { name: "Critérios de Framingham", desc: "Risco cardiovascular em 10 anos." }
      ],
      "Pediatria": [
        { name: "Doses Pediátricas", desc: "Calculadora de doses por peso." },
        { name: "Score de Apgar", desc: "Vitalidade neonatal." },
        { name: "Desidratação (OMS)", desc: "Classificação e Planos A, B, C." }
      ],
      "Emergência": [
        { name: "qSOFA", desc: "Critérios rápidos de sepse." },
        { name: "Glasgow", desc: "Escala de Coma." },
        { name: "Wells (TEP)", desc: "Probabilidade de Embolia Pulmonar." }
      ]
    };

    const SPECIALTIES_ICONS = {
      "IA Estratégica": Brain,
      "Cardiologia": Heart,
      "Pediatria": Baby,
      "Emergência": Siren
    };

    // --- UTILS ---
    const fileToGenerativePart = async (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64Data = reader.result;
          const base64Content = base64Data.split(',')[1];
          resolve({
            inlineData: {
              data: base64Content,
              mimeType: file.type,
            },
          });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    };

    const fileToDataUrl = async (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    };

    // --- COMPONENTS ---
    const Toast = ({ message, type, onClose }) => {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, [onClose]);

      return (
        <div className={`fixed top-4 right-4 z-[100] animate-in slide-in-from-right-10 fade-in duration-300 rounded-lg shadow-2xl p-4 flex items-center gap-3 border ${type === 'success' ? 'bg-emerald-50 border-emerald-200 text-emerald-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
          <div className={`p-1 rounded-full ${type === 'success' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}`}>
            {type === 'success' ? <Check size={16}/> : <AlertTriangle size={16}/>}
          </div>
          <span className="text-sm font-semibold">{message}</span>
          <button onClick={onClose} className="ml-2 opacity-50 hover:opacity-100"><X size={14}/></button>
        </div>
      );
    };

    const SimpleMarkdown = ({ content, theme }) => {
      if (!content) return null;
      const lines = content.split('\n');
      return (
        <div className={theme === 'dark' ? 'text-gray-100' : 'text-slate-800'}>
          {lines.map((line, i) => {
            if (line.startsWith('#')) return <h3 key={i} className="font-bold text-lg mt-2 mb-1 border-b border-gray-500/20">{line.replace(/^#+/, '')}</h3>;
            if (line.startsWith('-') || line.startsWith('*')) return <div key={i} className="ml-2 flex gap-2 mb-1"><span className="opacity-50">•</span><span>{line.substring(1)}</span></div>;
            if (line.trim() === '') return <div key={i} className="h-2"></div>;
            return <p key={i} className="mb-1">{line}</p>;
          })}
        </div>
      );
    };

    // --- THEMES ---
    const THEMES = {
      blue: { primary: 'blue', secondary: 'sky', accent: 'cyan', gradient: 'from-blue-700 to-sky-400', darkBg: 'bg-[#0b1121]', lightBg: 'bg-slate-50', panelDark: 'glass-dark border-blue-500/10', panelLight: 'glass-light border-slate-200' },
      violet: { primary: 'violet', secondary: 'fuchsia', accent: 'purple', gradient: 'from-violet-700 to-fuchsia-400', darkBg: 'bg-[#1a0b2e]', lightBg: 'bg-purple-50', panelDark: 'glass-dark border-violet-500/10', panelLight: 'glass-light border-purple-200' },
      emerald: { primary: 'emerald', secondary: 'teal', accent: 'green', gradient: 'from-emerald-700 to-teal-400', darkBg: 'bg-[#062c1b]', lightBg: 'bg-emerald-50', panelDark: 'glass-dark border-emerald-500/10', panelLight: 'glass-light border-emerald-200' },
      rose: { primary: 'rose', secondary: 'pink', accent: 'red', gradient: 'from-rose-700 to-pink-400', darkBg: 'bg-[#2e0b16]', lightBg: 'bg-rose-50', panelDark: 'glass-dark border-rose-500/10', panelLight: 'glass-light border-rose-200' },
      amber: { primary: 'amber', secondary: 'orange', accent: 'yellow', gradient: 'from-amber-700 to-orange-400', darkBg: 'bg-[#2e1d0b]', lightBg: 'bg-orange-50', panelDark: 'glass-dark border-amber-500/10', panelLight: 'glass-light border-orange-200' }
    };

    // --- MAIN APP ---
    function App() {
      const [theme, setTheme] = useState('dark');
      const [colorTheme, setColorTheme] = useState('blue');
      const [showSettings, setShowSettings] = useState(false);
      const [toast, setToast] = useState(null);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
      
      const [activeTab, setActiveTab] = useState('soap');
      const [patientData, setPatientData] = useState({ name: '', age: '', gender: '', id: '', dum: '', bed: '' });
      const [soap, setSoap] = useState({ s: '', o: '', a: '', p: '' });
      const [prescriptions, setPrescriptions] = useState([]);
      const [exams, setExams] = useState([]);
      const [doctorData, setDoctorData] = useState({ name: 'Dr. Nome Sobrenome', specialty: 'ESPECIALIDADE', crm: 'CRM 00000', address: 'Consultório', phone: '(00) 0000-0000' });
      
      const [isProcessing, setIsProcessing] = useState(false);
      const [processingStatus, setProcessingStatus] = useState('');
      const [showIgModal, setShowIgModal] = useState(false);
      const [igDateInput, setIgDateInput] = useState('');
      const [igResult, setIgResult] = useState('');
      
      // Clinical Tools
      const [selectedSpecialty, setSelectedSpecialty] = useState(null);
      const [selectedTool, setSelectedTool] = useState(null);
      const [toolInput, setToolInput] = useState('');
      const [toolImage, setToolImage] = useState(null);
      const [toolOutput, setToolOutput] = useState('');
      const [fluxoImage, setFluxoImage] = useState(null);

      // Prescriber
      const [searchTerm, setSearchTerm] = useState('');
      const [showManualAdd, setShowManualAdd] = useState(false);
      const [manualItem, setManualItem] = useState({ type: 'med', name: '', details: '' });

      // Docs
      const [docType, setDocType] = useState('receita');
      const [logoImage, setLogoImage] = useState(null);

      const toggleTheme = () => setTheme(prev => prev === 'dark' ? 'light' : 'dark');
      const currentTheme = THEMES[colorTheme];
      const primaryColor = currentTheme.primary;
      const secondaryColor = currentTheme.secondary;
      
      const bgClass = theme === 'dark' ? `${currentTheme.darkBg} text-${secondaryColor}-50` : `${currentTheme.lightBg} text-slate-800`;
      const panelClass = theme === 'dark' ? currentTheme.panelDark : currentTheme.panelLight;
      const inputClass = theme === 'dark' ? `bg-gray-900 border-${primaryColor}-800/30 text-white placeholder-gray-500` : `bg-white border-slate-300 text-slate-900`;
      const subText = theme === 'dark' ? `text-${primaryColor}-300/60` : 'text-slate-500';

      useEffect(() => {
        if (apiKey) localStorage.setItem('gemini_api_key', apiKey);
      }, [apiKey]);

      useEffect(() => {
        if (!apiKey) setShowSettings(true);
      }, []);

      const showToastMessage = (msg, type) => setToast({ message: msg, type });

      const getAI = () => {
        if (!apiKey) {
          setShowSettings(true);
          showToastMessage("Insira sua API Key nas configurações.", "error");
          throw new Error("API Key missing");
        }
        return new GoogleGenAI({ apiKey });
      };

      const handleMagicSoap = async (file) => {
        try {
          setIsProcessing(true);
          setProcessingStatus("Analisando arquivo...");
          const ai = getAI();
          const part = await fileToGenerativePart(file);
          
          const prompt = `Transcreva e organize este arquivo de áudio/imagem médica no formato SOAP (JSON). Campos: subjective, objective, assessment, plan.`;
          
          const response = await ai.models.generateContent({
            model: 'gemini-1.5-flash',
            contents: { parts: [part, { text: prompt }] },
            config: { responseMimeType: "application/json" }
          });
          
          const data = JSON.parse(response.text);
          setSoap(prev => ({
            s: prev.s + (data.subjective || ''),
            o: prev.o + (data.objective || ''),
            a: prev.a + (data.assessment || ''),
            p: prev.p + (data.plan || '')
          }));
          showToastMessage("Transcrição realizada!", "success");
